<!DOCTYPE html>
<html>

<head>
  <title>Shipment Tracking</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <link rel="shortcut icon" type="image/png" href="favicon.ico" />
  <style>
    html,
    body {
      height: 100%;
      margin: 0px;
      padding: 0px;
      overflow: hidden; /* Hide scrollbars */
    }

    #map-canvas {
      height: 100%;
      margin: 0px;

    }
  </style>
  <!--script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9JGEC8ucg3DFD2gSdyqDIptMLkkHKfqM&v=3.exp&libraries=visualization"></script-->
  <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAA3Ha2YY5FRMy4T4gtr8ONBK_UnQj_HuU&v=beta"></script> -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAA3Ha2YY5FRMy4T4gtr8ONBK_UnQj_HuU&v=beta"></script>
  <script type="text/javascript" src="solclient-full.js"></script>
  <script type="text/javascript" src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <!--script type="text/javascript" src="marker_with_label.js"></script-->
  <script type="text/javascript" src="qrcode.min.js"></script>
<!--  <div>
    <label for="order-id">Order ID:</label>
    <input type="text" id="order-id" value="12345"><br>
    <button onclick="this.onLogin()">Get Shipment Location</button>
</div> -->

  <script>

    function makeHtmlColors(topic) {
      var levels = topic.split("/");
      var str = "";
      for (var i=0; i<levels.length; i++) {
          str += "<span style=\"color: "+levelColors[i]+";\">" + levels[i] + "</span>";
        if (i < levels.length-1) str += "/";
      }
      if (levels.length < 7) str += "<span style=\"color: "+levelColors[0]+";\">&gt;</span>";
      return str;
    }



    this.initialize = function() {
      var mapOptions = {
        mapId: 'b3ae7d523f6e790d',
        tilt: 25,
        center: new google.maps.LatLng(54.5260,-105.2551), // North America
        //center: new google.maps.LatLng(1.34,103.85), // Singapore
        // center: new google.maps.LatLng(45.0, -93), // Minneapolis/St.Paul
        zoom: 5, // demo
        draggable: true,
         mapTypeId: 'hybrid',
         mapTypeControlOptions: {
          mapTypeIds: ['coordinate', 'roadmap', 'terrain', 'satellite'],
         },
           drawable: true,
           clickable: false,
      };
	      delete mapOptions.styles;
       map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

     boundary = [];
      for (var i = 0; i < 2; i++) { // there's two because there are two shapes... need to change
        boundary[i] = new google.maps.Polygon({
          map: map,
          strokeColor: '#0000FF',
          strokeOpacity: 0.8,
          strokeWeight: 1,
          fillColor: '#0000FF',
          fillOpacity: 0.05,
          map: map,
          zIndex: 10,
          clickable: true,
          draggable: false,
          editable: false,
        });
     } 

 

      //////////////////////////////////////////////////////////


      zoomLevel = Math.round(map.getZoom());
      google.maps.event.addListener(map, 'zoom_changed', function () {
        console.log("Zoom changed!!  from " + zoomLevel + " to " + map.getZoom());
        zoomLevel = Math.round(map.getZoom());
        if (zoomLevel < 17) map.setMapTypeId('hybrid');
        else map.setMapTypeId('hybrid');
      });

    }
    /////////// END OF MAP INITIALIZE method ////////////////////////////////////////
    google.maps.event.addDomListener(window, 'load', initialize);

    // solace code //////////////////////////////////////////////////////////////////////////////

    var OPERATION_TIMEOUT = 30000;
    var REQUEST_TIMEOUT = 10000;
    var ns = this;
    /**
     * Data members in the global scope
     */
    var mySessionProperties = null;
    var mySession = null;
    var requestTopic = 'request/geo_filter';
    var connected = false;
    var working = false;
    var fenceUid = "" + (Math.random() + 1).toString(36).substring(2, 6);  // generate a "random" [0-9a-z] 4 char ID
    console.log("Fence UID: " + fenceUid);

    var sessionEventCb; // forward declaration
    var messageEventCb; // forward declaration

    var replyReceivedCb; // forward declaration
    var replyFailedCb; // forward declaration
    var marker;

    /**
     * Creates a message to with queryType as message's binary attachment
     * @param queryType
     * @return {solace.Message} message
     */
    this.createRequestMsg = function (polyCoordStr) {
      var msg = solace.SolclientFactory.createMessage();
      // Set the topic to requestTopic
      msg.setDestination(solace.SolclientFactory.createTopic(requestTopic));
      // Set delivery mode
      msg.setDeliveryMode(solace.MessageDeliveryModeType.DIRECT);
      // Set binary attachment
      msg.setBinaryAttachment(polyCoordStr);
      return msg;
    };

    /**
     * Invoked when the Ok button is clicked on the login dialog. This method will trigger the creation and connect()
     * operation on the session. When successfully connected, handle_sessionConnected() is invoked
     */
    this.onLogin = function () {
      try {
        // Create Session
        mySessionProperties = new solace.SessionProperties();
        mySessionProperties.connectTimeoutInMsecs = OPERATION_TIMEOUT;
        mySessionProperties.readTimeoutInMsecs = OPERATION_TIMEOUT;
        mySessionProperties.keepAliveIntervalsLimit = 10;
        mySessionProperties.userName = "default";
        mySessionProperties.password = "default";
        mySessionProperties.vpnName = "neha";
        mySessionProperties.url = "wss://neha.messaging.solace.cloud:443"; 

        mySessionProperties.includeSenderId = true;
  
        console.log("1");
        mySession = solace.SolclientFactory.createSession(mySessionProperties,
          new solace.MessageRxCBInfo(function (session, message) {
            messageEventCb(session, message);
          }, this),
          new solace.SessionEventCBInfo(function (session, event) {
            sessionEventCb(session, event);
          }, this));
        console.log("Session was successfully created.");
        // Connect it
        mySession.connect();
        console.log("Session was successfully connected.");
        // start a background process to slowly facde out icons
        setInterval(500);

      } catch (error) {
        console.log("Could not login!");
        console.log(error.toString());
        if (mySession !== null) {
          mySession.dispose();
          mySession = null;
          connected = false;
        }
      }
      lastMsgCount = 0;
      discardCount = 0;
      //setTimeout(function(){ alert("Click 'Remove all shapes' to start the bus demo."); },3000);

    };

    /**
     * The session was successfully connected, the next step is to add the 'rendez-vous' topic subscription
     */
    this.handle_sessionConnected = function () {
      connected = true;
      try {
        mySession.subscribe(solace.SolclientFactory.createTopic("shipment/position/data"), false, this, OPERATION_TIMEOUT);
        console.log("2");
      } catch (error) {
        console.log("Failed to add topic subscription. Disconnecting!");
        console.log(error.toString());
        if (mySession !== null) {
          mySession.dispose();
          mySession = null;
        }
        connected = false;
      }
    };

    /**
     * The subscription was successfully added, the next step is to send a 'I am logged in' message
     */
    this.handle_subscriptionOperationSucceeded = function () {
      console.log("subscription added");
    };

    /**
     * General failure
     * @param text
     * @param updateContent
     */
    this.handle_failure = function (text, updateContent) {
      console.log(text);
      connected = false;
      //        ns.cleanup();
    };

    /**
     * General cleanup
     */
    this.cleanup = function () {
      if (mySession !== null) {
        mySession.dispose();
        mySession = null;
        connected = false;
      }
    };

    ////////////////////// Callback functions //////////////////////////////////////////////////////////////////////////////

    /**
     * Session event callback
     * @param session
     * @param event
     */
    sessionEventCb = function (session, event) {
      console.log(event.toString());
      if (event.sessionEventCode === solace.SessionEventCode.UP_NOTICE) {
        ns.handle_sessionConnected();
      } else if (event.sessionEventCode === solace.SessionEventCode.SUBSCRIPTION_OK) {
        ns.handle_subscriptionOperationSucceeded();
      } else if (event.sessionEventCode === solace.SessionEventCode.SUBSCRIPTION_ERROR) {
        ns.handle_failure("Failed to add subscription", true);
      } else if (event.sessionEventCode === solace.SessionEventCode.LOGIN_FAILURE) {
        ns.handle_failure("Failed to login to appliance:" + event.infoStr, true);
      } else if (event.sessionEventCode === solace.SessionEventCode.CONNECTING) {
        console.log("Connecting...");
      } else if (event.sessionEventCode === solace.SessionEventCode.DISCONNECTED) {
        ns.handle_failure("Session is disconnected", false);
      } else {
        ns.handle_failure("Session failure!", false);
      }
    };

    /**
     * Direct message receive callback
     * @param session
     * @param message
     */


    messageEventCb = function (session, message) {
      try {
        console.log("3");
        var topic = message.getDestination().getName();
        console.log("4");        
        //document.getElementById('topic').innerHTML = makeHtmlColors(topic);
        console.log("5");
        parseGeoMessage(message);
      } catch (e) {
        console.log(message);
        console.log(e);
        throw e;
      }

    }

    getTextPayload = function (message) {
      if (message.getType() == solace.MessageType.TEXT) {
        return message.getSdtContainer().getValue();
      } else {
        return message.getBinaryAttachment(); // binary attachment, all text
      }
    }



    parseGeoMessage = function (message) {
    try {
      console.log("6");
      var levels = message.getDestination().getName().split("/"); // topic levels
      console.log("7");
      var payload = JSON.parse(getTextPayload(message));
      console.log("8");
      console.log(payload);
      var lat = payload.latitude;
      var lon = payload.longitude;
      if (marker) {
                marker.setMap(null);
            }
      var image = {
                url: 'green_med_fault.png', // URL of your custom image
                // Size and scaling of the image
                size: new google.maps.Size(32, 32),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(16, 32)
            };

            // Create a marker and set its position
                marker = new google.maps.Marker({
                //position: {lat: 37.7749, lng: -122.4194}, 
                position: {lat: lat, lng: lon}, // Marker position
                map: map,
                icon: image, // Custom image
                title: 'San Francisco, CA' // Title for the marker
            });

            // Create an InfoWindow object
            var infoWindow = new google.maps.InfoWindow({
                content: '<div><strong>Your Shipment is here</strong><br></div>'
            });

            // Add a click event listener to the marker to open the InfoWindow
            marker.addListener('click', function() {
                infoWindow.open(map, marker);
            });
} catch (e) {
  console.error(e);
  // discard silently for now
}
    }  // end parseGeoMessage


    replyReceivedCb = function (session, message) {
      var text = message.getBinaryAttachment();
      updateSubs(text);
    };

    replyFailedCb = function (session, event) {
      //console.log(event.infoStr);
      //console.log(event.toString());
      setWorking(false);
    };

    this.utils_updateContent = function (msg) {
      console.log("content: '" + msg + "'");
    };

    function myFunction() {
      var x = document.createElement("INPUT");
      x.setAttribute("type", "range");
      document.body.appendChild(x);
    }

    function logslider(position) {
      // position will be between 0 and 100
      var minp = 0;
      var maxp = 100;
      // The result should be between 4 and 2000
      var minv = Math.log(4);
      var maxv = Math.log(1500);
      // calculate adjustment factor
      var scale = (maxv - minv) / (maxp - minp);
      return Math.round(Math.exp(minv + scale * (position - minp)));
    }

    function revlogslider(position) {
      // position will be between 0 and 100
      var minp = 100; // reverse so it gets slower towards the top
      var maxp = 0;
      // The result should be between 10 and 99%
      var minv = Math.log(10);
      var maxv = Math.log(99);
      // calculate adjustment factor
      var scale = (maxv - minv) / (maxp - minp);
      return Math.round(109 - Math.exp(minv + scale * (position - minp))); // subtract from 109 to flip the range from 99-10 => 10-99
    }

    google.maps.event.addDomListener(window, 'load', onLogin);
  </script>
</head>

<body>

<div id="map-canvas"></div>
  <div>
    <label for="latitude">Latitude:</label>
    <input type="text" id="latitude" value="37.7749"><br>
    <label for="longitude">Longitude:</label>
    <input type="text" id="longitude" value="-122.4194"><br>
    <label for="order-id">Order ID:</label>
    <input type="text" id="order-id" value="12345"><br>
    <button onclick="updateMarker()">Set Marker</button>
</div>
  <script>
   document.getElementById("over_map_fence").style.display = "none";
   document.getElementById("topicMO").style.display = "none";
   </script>
</body>

</html>
